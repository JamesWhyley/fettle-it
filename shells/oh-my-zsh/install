# External plugin sources
custom_plugins=(
  "https://github.com/Aloxaf/fzf-tab"
  "https://github.com/zdharma-continuum/fast-syntax-highlighting"
)
# Native plugins to load
plugins=(
  "asdf"
  "fzf"
  "git"
  "httpie"
  "safe-paste"
  "vscode"
)

settings=(
  "ZSH_THEME="
  "DISABLE_LS_COLORS=true"
)

install_omz() {
  if [ -d "${HOME}/.oh-my-zsh" ]; then
    warn "oh-my-zsh directory already exists ➡ skipping install"
  else
    substep "Installing oh-my-zsh"
    RUNZSH=no KEEP_ZSHRC=yes sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    substep_done "Installing oh-my-zsh ➡ complete"
  fi
  set_config
}

set_config() {
  append_to_file "${config_path}" "# oh-my-zsh"
  append_to_file "${config_path}" "export ZSH=\${HOME}/.oh-my-zsh"

  for setting in "${settings[@]}"; do
    if [ "$1" = update ]; then
      name="$(echo "${setting}" | cut -d'=' -f 1)"
      substep_done "Set: ${setting}"
      if grep -Fsq "${name}" "${config_path}"; then
        sed -i '' "/${name}/d" "${config_path}"
      fi
    fi
    append_to_file "${config_path}" "${setting}"
  done

  # Load plugins
  if [ "$1" = update ]; then
    substep_done "Set: plugins=(${plugins[*]})"
    if grep -Fsq  "plugins=" "${config_path}"; then
      sed -i '' "/plugins=/d" "${config_path}"
    fi
  fi
  append_to_file "${config_path}" "plugins=(${plugins[*]})"

  # Override some default aliases e.g. ls
  if [ -f "${HOME}/.fettle-it/customisations/aliases" ]; then
    ln -sf "${HOME}/.fettle-it/customisations/aliases" "${HOME}/.oh-my-zsh/custom/aliases.zsh"
  fi

  # Enxure source stays near the end
  sed -i '' "/source\ \${ZSH}\/oh-my-zsh\.sh/d" "${config_path}"
  append_to_file "${config_path}" "source \${ZSH}/oh-my-zsh.sh"
  sed -i '' '/^[[:space:]]*$/d' "${HOME}/.fettle-it/customisations/zsh/custom"
}

install_plugins() {
  for custom_plugin in "${custom_plugins[@]}"; do
    plugin="${custom_plugin##*/}"
    plugin_dir="${ZSH_CUSTOM:-${HOME}/.oh-my-zsh/custom}/plugins/${plugin}"
    plugins+=("${plugin}")

    if [ -d "${plugin_dir}" ]; then
      warn "oh-my-zsh plugin ${plugin} already exists ➡ skipping install"
    else
      substep "Installing oh-my-zsh plugin ${plugin}"
      git clone "${custom_plugin}" "${plugin_dir}"
      substep_done "Installing oh-my-zsh plugin ${plugin} ➡ complete"
    fi
  done
}

main() {
  local config_path="${HOME}/.fettle-it/customisations/zsh/custom"
  install_omz
  install_plugins
  set_config update
}

main

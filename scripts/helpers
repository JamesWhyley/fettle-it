#!/bin/bash

# Fail fast
set -o errexit

# Pretty colours
BLACK="$(tput setaf 0)"
BLACK_BG="$(tput setab 0)"
RED="$(tput setaf 1)"
RED_BG="$(tput setab 1)"
GREEN="$(tput setaf 2)"
GREEN_BG="$(tput setab 2)"
YELLOW="$(tput setaf 3)"
YELLOW_BG="$(tput setab 3)"
BLUE="$(tput setaf 4)"
BLUE_BG="$(tput setab 4)"
MAGENTA="$(tput setaf 5)"
MAGENTA_BG="$(tput setab 5)"
CYAN="$(tput setaf 6)"
CYAN_BG="$(tput setab 6)"
WHITE="$(tput setaf 7)"
WHITE_BG="$(tput setab 7)"
RESET="$(tput sgr0)"
BOLD="$(tput bold)"
UNDERLINE="$(tput smul)"
MYSTERY="$(tput setaf "$(awk 'BEGIN { srand(); printf("%d\n", 256 * rand()) }')")"

# Pointless things
banner() {
  get_fettlin="$(
    cat <<EOL

   █████████            █████       ███████████           █████     █████    ████   ███              ██
  ███░░░░░███          ░░███       ░░███░░░░░░█          ░░███     ░░███    ░░███  ░░░              ███
 ███     ░░░   ██████  ███████      ░███   █ ░   ██████  ███████   ███████   ░███  ████  ████████  ░░░ 
░███          ███░░███░░░███░       ░███████    ███░░███░░░███░   ░░░███░    ░███ ░░███ ░░███░░███     
░███    █████░███████   ░███        ░███░░░█   ░███████   ░███      ░███     ░███  ░███  ░███ ░███     
░░███  ░░███ ░███░░░    ░███ ███    ░███  ░    ░███░░░    ░███ ███  ░███ ███ ░███  ░███  ░███ ░███     
 ░░█████████ ░░██████   ░░█████     █████      ░░██████   ░░█████   ░░█████  █████ █████ ████ █████    
  ░░░░░░░░░   ░░░░░░     ░░░░░     ░░░░░        ░░░░░░     ░░░░░     ░░░░░  ░░░░░ ░░░░░ ░░░░ ░░░░░     
EOL
  )"

  awk 'BEGIN { srand(); printf("%d %d\n", 256 * rand(), 256 * rand()) }' |
    while read -r one two; do
      echo "${get_fettlin}" |
        sed "s/█/$(tput setab "${one}") ${RESET}/g" |
        sed "s/░/$(tput setab "${two}") ${RESET}/g"
    done
}

# Decision makers
choose_wisely() {
  select yn in "Yes" "No"; do
    case ${yn} in
    Yes) break ;;
    No)
      step_done "Very well"
      exit
      ;;
    esac
  done
}

# File helpers
append_to_file() {
  local file="$1"
  local text="$2"
  local check_local="$3"
  local localfile="${file}.local"

  if [ "${check_local}" ] && [ -e "${localfile}" ]; then
    debug "Using '${localfile}' instead of '${file}'"
    file=${localfile}
  fi

	debug "Checking '${file}' for '${text}'"

  if ! grep -Fsq "${text}" "${file}"; then
		debug "Appending ${text} to ${file}"
    echo -e "\n${text}">>"${file}"
	else
		debug "Found string in file, doing nothing."
  fi
}

prepend_to_file() {
  local file="$1"
  local text="$2"

	debug "Checking '${file}' for '${text}'"

  if test -f "${file}"; then
    if ! grep -Fsq "${text}" "${file}"; then
      debug "Prepending ${text} to ${file}"
      echo -e "${text}\n\n$(cat "${file}")">"${file}"
    else
      debug "Found string in file, doing nothing."
    fi
  else
    debug "${file} does not exist, creating it."
    echo -e "${text}">"${file}"
  fi
}

# Output helpers
bold() {
  echo "${BOLD}$*${RESET}"
}

debug() {
  [[ -z ${DEBUG} ]] || echo "${YELLOW}DEBUG:${RESET} $*"
}

err() {
  echo "${RED}$*${RESET}"
}

mystery() {
  echo "${MYSTERY}$*${RESET}"
}

step() {
  echo
  echo "${BOLD}$*${RESET}"
}

step_done() {
  echo "${BOLD}$*${RESET}"
}

substep() {
  echo "${BLUE}➡ $*${RESET}"
}

substep_done() {
  echo "${GREEN}➡ $*${RESET}"
}

underline() {
  echo "${UNDERLINE}$*${RESET}"
}

info() {
  echo "${WHITE_BG}${BLACK}  $*  ${RESET}"
}

warn() {
  echo "${YELLOW}➡ $*${RESET}"
}

warn_bg() {
  echo "${RED_BG}${WHITE}  $*  ${RESET}"
}

# show warnings for your current cluster and copy the log line on pressing enter
# requires fzf, jq
plugins:
  search-journal:
    shortCut: Shift-J
    confirm: false
    description: Search Journal
    scopes:
    - nodes
    command: sh
    background: false
    args:
    - -c
    - |
      GREEN="$(tput setaf 2)"
      RESET="$(tput sgr0)"

      aws sts get-caller-identity > /dev/null #Needed to prompt for MFA code if credentials aren't cached

      NODE=$(kubectl get nodes "$NAME" -o jsonpath='{.metadata.name}')

      CHOSEN_INSTANCE=$(aws ec2 describe-instances \
          --query "Reservations[*].Instances[*].{InstanceID:InstanceId,Name:Tags[?Key=='Name']|[0].Value,LaunchTime:LaunchTime}" \
          --filters "Name=tag:Name,Values=${NODE}" | \
        jq -r '. | flatten | sort_by(.Name) | .[] | .InstanceID + ": " + .Name + "; " + .LaunchTime' | \
        cut -d ":" -f 1)

        if [ -z "${NODE}" ]; then
          echo "No node detected - exiting"
          exit
        else
          echo "Connecting to node:      ${GREEN}${CHOSEN_INSTANCE}${RESET}"
          echo "Hostname:                ${GREEN}${NODE}${RESET}"
          echo "Connection started from: ${GREEN}${NAME}${RESET}"
          echo "Resource type:           ${GREEN}${TYPE}${RESET}"
          aws ssm send-command \
            --instance-ids "${CHOSEN_INSTANCE}" \
            --document-name "AWS-RunShellScript" \
            --comment "IP config" \
            --parameters "commands=ifconfig"
          exit
        fi
        exit

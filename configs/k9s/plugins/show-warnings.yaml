# vim:ft=yaml
# $XDG_CONFIG_HOME/k9s/plugins/show-warnings.yaml
# show warnings for your current cluster and copy the log line on pressing enter
# requires fzf, jq
plugins:
  show-warnings:
    shortCut: Shift-W
    confirm: false
    description: Show Warnings
    scopes:
    - all
    command: sh
    background: false
    args:
    - -c
    - |
      WARNINGS=$(kubectl events --all-namespaces=true --types=Warning --output json | \
      jq -r '("Timestamp|Type|Reason|Name|Namespace|Message"), (.items[] | "\(.metadata.creationTimestamp)|\(.type)|\(.reason)|\(.metadata.name)|\(.metadata.namespace)|\(.message)")' | \
      sort -r | \
      column -t -s "|")

      clear
      echo "${WARNINGS}" | \
      fzf \
        --bind 'enter:execute-silent(echo {+} | pbcopy)+accept' \
        --bind pg'dn:page-down' \
        --bind pgu'p:page-up' \
        --border \
        --header-lines 1 \
        --height=25% \
        --prompt="What are you looking for? " \
        --preview "echo {} | tr -s ' ' | cut -d' ' -f5-" \
        --preview-window=bottom,wrap
      exit 0

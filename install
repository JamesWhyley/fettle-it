#!/bin/sh

# Fail fast
set -o errexit

source ./fettlers

configure_git() {
  step "Configuring Git"
  substep "Add gitconfig"
  git_config="[include]
  path = ~/.fettle-it/gitconfig"
  append_to_file "$git_config" "${HOME}"/.gitconfig
  substep_done "Add gitconfig ➡ complete"

  substep "Configure Github user"
  if ! git config user.name > /dev/null; then
    git_user_name=$(gum input --placeholder "Github name")
    git config --global user.name "${git_user_name}"
  fi
  substep_done "User name set"

  if ! git config user.email > /dev/null; then
    git_user_email=$(gum input --placeholder "Github email")
    git config --global user.email "${git_user_email}"
  fi
  substep_done "User email set"

  if ! git config user.signingkey > /dev/null; then
    git_user_signingkey=$(gum input --placeholder "Github signing key")
    git config --global user.signingkey "${git_user_signingkey}"
  fi
  substep_done "Signing key set"
  substep_done "Configure Github user ➡ complete"
  step_done "Done"
}

configure_ssh() {
  step "Configuring SSH"
  if which op > /dev/null; then
    mystery "1Password cli is installed ➡ configuring"

    substep "Checking 1password agent symlink"
    OPSYMLINK=~/.1password/agent.sock
    if [ ! -L $OPSYMLINK ]; then
      substep "Creating 1Password agent symlink"
      mkdir -p ~/.1password && ln -s ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock $OPSYMLINK
    fi
    substep_done "Checking 1password agent symlink ➡ complete"

    substep "Configure .ssh/config"
    ssh_config="Host *
    IdentityAgent ~/.1password/agent.sock"
    append_to_file "$ssh_config" "${HOME}"/.ssh/config
    substep_done "Configure .ssh/config ➡ complete"

    substep "Configure Git"
    git config --global gpg.ssh.program "/Applications/1Password.app/Contents/MacOS/op-ssh-sign"
    substep_done "Configure Git ➡ complete"
  elif which bw > /dev/null; then
    mystery "Bitwarden cli is installed ➡ configuring"

    substep "Checking Bitwarden agent symlink"
    OPSYMLINK="${HOME}"/.bitwarden-ssh-agent.sock
    if [ ! -L "$OPSYMLINK" ]; then
      substep "Check the Bitwarden SSH agent is running"
      exit 0
    fi
    substep_done "Checking Bitwarden agent symlink ➡ complete"

    substep "Configure .ssh/config"
    ssh_config="Host *
    IdentityAgent ${HOME}/.bitwarden-ssh-agent.sock"
    append_to_file "$ssh_config" "${HOME}"/.ssh/config
    substep_done "Configure .ssh/config ➡ complete"

    substep "Configure Git"
    git config --global gpg.ssh.allowedSignersFile "${HOME}"/.ssh/allowedSigners
    substep_done "Configure Git ➡ complete"
  else
    warn "No credential manager detected"
    warn "Continue anyway?"
    gum confirm  || exit 0
  fi
  step_done "Done"
}

install_dependencies() {
  step "Installing dependencies"
  if ! which brew > /dev/null; then
    warn "Homebrew is not installed"
    substep "Do you want to install Homebrew?"
    substep "Selecting yes will execute the following command"
    echo ""
    warn '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    echo ""
    substep "Are you happy to continue?"
    choose_wisely
    echo ""

    # Install Hombrew and prep for first run
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi

  if which brew > /dev/null; then
    substep_done "Homebrew is configured"
  fi

  if ! which gum > /dev/null; then
    warn "Gum is not installed"
    substep "Installing gum"
    brew install gum > /dev/null 2>&1
    substep_done "Gum installed"
  fi

  substep "Processing common brewfile"
  gum spin --spinner points --title "Grab a cuppa" -- brew bundle
  substep_done "Processing common brewfile ➡ complete"

  shopt -s nullglob
  BREWFILES=(Brewfile.*)

  for file in "${BREWFILES[@]}"; do
   GETTYPES+=("$(echo "$file" | cut -d'.' -f2)")
  done

  TYPES=$(gum choose --header "What's the nature of the beast?" --no-limit "${GETTYPES[@]}")
  for type in $TYPES; do
    substep "Processing $type brewfile"
    gum spin --spinner points --title "Installing $type applications" -- brew bundle --file=Brewfile."${type}"
    substep_done "Processing $type brewfile ➡ complete"
  done
  step_done "Done"
}

setup_work_dir() {
  step "Checking for working directory"

  if [ ! -d "${HOME}/code" ]; then
    warn "Working directory not found"
    substep "Creating working directory"
    mkdir "${HOME}/code"
  fi

  if [ -d "${HOME}/code" ]; then
    substep_done "Working directory set to \"${HOME}/code\""
  fi

  step_done "Done"
}

main() {
  banner
  setup_work_dir
  install_dependencies
  configure_git
  configure_ssh
}

main
